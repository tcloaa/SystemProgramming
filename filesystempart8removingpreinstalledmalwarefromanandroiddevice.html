<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>File System, Part 8: Removing preinstalled malware from an Android device</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="images/android-desktop.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="images/ios-desktop.png">

    <link rel="shortcut icon" href="images/favicon.png">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <link href='//fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <link rel="stylesheet" href="material.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/buttons-min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  </head>
  <body>
    <div class="demo-layout mdl-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100">
      <header class="demo-header mdl-layout__header mdl-layout__header--scroll mdl-color--grey-100 mdl-color-text--grey-800">
        <div class="mdl-layout__header-row">
        <span class="mdl-layout-title">File System, Part 8: Removing preinstalled malware from an Android device</span>
          <div class="mdl-layout-spacer"></div>
        </div>
      </header>
      <div class="demo-ribbon"></div>
      <main class="demo-main mdl-layout__content">
        <div class="demo-container mdl-grid">
          <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
          <div class="demo-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
            <div class="demo-crumbs mdl-color-text--grey-500">
                CS 241 &gt; Wikibook &gt; File System, Part 8: Removing preinstalled malware from an Android device
            </div>
            <h3>File System, Part 8: Removing preinstalled malware from an Android device</h3>

<p>Case study: Removing malware from an Android device</p>
<p>This section uses filesystem features and system programming tools discussed in this wikibook to find and remove unwanted malware from an Android tablet. </p>
<p>DISCLAIMER. ENSURE ANY VALUABLE INFORMATION ON YOUR DEVICE IS BACKED UP BEFORE ATTEMPTING TO MODIFY YOUR TABLET. MODIFYING SYSTEM SETTINGS AND SYSTEM FILES IS NOT RECOMMENDED. ATTEMPTING TO MODIFY A DEVICE USING THIS CASE STUDU GUIDE MAY CAUSE YOUR TABLET TO SHARE, LOSE OR CORRUPT YOUR DATA DATA. FURTHER YOUR TABLET MAY FUNCTION INCORRECTLY OR TO STOP FUNCTIONING ALTOGETHER. USE THIS CASE STUDY AT YOUR OWN RISK. THE AUTHORS ASSUME NO RESPONSIBILITY AND MAKE NO WARRANTY ABOUT THE CORRECTNESS OR COMPLETENESS OF THESE INSTRUCTIONS INCLUDED IN THIS CASE STUDY. THE AUTHORS ASSUME NO RESPONSIBILITY AND MAKE NO WARRANTY ABOUT ANY SOFTWARE INCLUDING EXTERNAL THIRD PARTY SOFTWARE DESCRIBED OR LINKED TO IN THIS GUIDE.</p>
<h1>Background</h1>
<p>An E97 Android tablet purchased from Amazon had developed some peculiar quirks. Most noticeable was that the browser app always opened a website at gotoamazing.com rather than the home page set in the app's preferences (known as browser 'hijacking'). Can we use the knowledge from this wikibook to understand how this unwanted behavior occurs and also remove unwanted pre-installed apps from the device?</p>
<h1>Tools used</h1>
<p>While it is possible to use the Android developer tools installed on a remote USB-connected machine, this guide uses only system tools on the tablet. The following apps were installed - </p>
<ul>
<li>Malwarebytes - A free vulnerability and malware tool.</li>
<li>Terminal emulator - A simple terminal window that gives us shell access on the tablet.</li>
<li>KingRoot - A tool that uses known exploits in the linux kernel to gain root access.</li>
</ul>
<p>Installing any app can potentially allow arbitrary code to be executed if it is able to break out of the Android security model. Of the apps mentioned above, KingRoot is the most extreme example because it exploits system vulnerabilities to gain root access for our purposes. However in doing so, it could also <br />
Of these, KingRoot is the most questionable tool to install - we are trusting it not to install any of its own malware. A potentially safer alternative is to use <a href="https://github.com/android-rooting-tools/">https://github.com/android-rooting-tools/</a></p>
<h1>Overview of terminal</h1>
<p>The most useful commands are  <code>su grep mount</code> and Android's package manager tool, <code>pm</code>.</p>
<ul>
<li>grep -s abc * <em>/</em>   (search for <code>abc</code> in current directory and immediate sub directories)</li>
<li>su ( aka "switch user" become root - requires a rooted device)</li>
<li>mount -o rw,remount /system  (allow /system partition to be writeable)</li>
<li>pm disable  (aka 'package manager' disable an Android app package)</li>
</ul>
<h1>Overview of filesystem layout</h1>
<p>On this specific tablet that runs Android 4.4.2, pre-installed apps are unmodifiable and are located in</p>
<pre class="highlight"><code>/system/app/
/system/priv-app/</code></pre>


<p>and preferences and app-data are stored in the <code>/data</code> partition<br />
Each app is typically packaged inside an apk file, which is essentially a zip file. When an app is installed the code is expanded into a file that can be directly parsed by the Android virtual machine. The binary code (at least for this particular virtual machine) has an odex extension.</p>
<p>We can search the code of the installed system apps for the string 'gotoamazing'</p>
<pre class="highlight"><code>grep -s gotoamazing /system/app/* /system/priv-app/*</code></pre>


<p>This didn't find anything; it appears this string was not hardcoded into the source code of the given system apps. To verify that we can find </p>
<p>Let's check the data area of all installed apps</p>
<pre class="highlight"><code>cd /data/data
grep -s gotoamazing * */* */*/*</code></pre>


<p>produced the following</p>
<pre class="highlight"><code>data/com.android.browser/shared_prefs/xbservice.xml: &amp;lt;string name=&quot;URL&quot;&amp;gt;http://www.gotoamazing...</code></pre>


<p>The -s option "silent option" stops grep from complaining about trying to grep directories and other invalid files. Note we could have also used -r to recursively search directories but it was fun to use file globbing (wildcard expansion of the * by the shell).</p>
<p>Now we are getting somewhere! It looks like this string is part of the app 'com.android.browser' but let's also find out which app binary code opens the 'xbservice' preference. Perhaps this unwanted service is hiding inside another app and managed to secretly load as an extension to the browser?</p>
<p>Let's look for any file that contains xbservice. This time we will recursively search in the directories of /system that include the 'app'</p>
<pre class="highlight"><code>grep -r -s xbservice /system/*app*
Binary file /system/app/Browser.odex matches</code></pre>


<p>Finally - it appears the factory browser was shipped with the the home page hijacking pre-installed. Let's uninstall it. For this, let's become root.</p>
<p>`<br />
$ su</p>
<h1>pm list packages -s</h1>
<p>`<br />
Android's package manager has many commands and options. The above example lists all currently installed system apps. We can uninstall the browser app using the following command</p>
<pre class="highlight"><code>pm disable com.android.browser
pm uninstall com.android.browser</code></pre>


<p>Using <code>pm list packages</code> you can list all installed packages (use <code>-s</code> options to see just system packages). We disabled the following system apps. Of course there is no real guarantee that we successfully removed all unwanted software, or that one of these is a false-positive. As such we would not recommend keeping sensitive information on such a tablet.</p>
<ul>
<li>com.android.browser</li>
<li>com.adups.fota.sysoper</li>
<li>elink.com</li>
<li>com.google.android.apps.cloudprint</li>
<li>com.mediatek.CrashService</li>
<li>com.get.googleApps</li>
<li>com.adups.fota (an over-the-air package that can install arbitrary items in the future).</li>
<li>com.mediatek.appguide.plugin</li>
</ul>
<p>It is likely that you could just re-enable a package using <code>pm enable package-name</code> or <code>pm install</code> and the relevant .apk file in /system/app or /system/priv-app</p>          </div>
        </div>
      </main>
    </div>
    <script src="check_mc.js"></script>
  </body>
</html>